<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GameTrak - Video Game Database</title>
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone@7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // ðŸ”¥ REPLACE WITH YOUR FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyCbA8DPjr2kq-id8uk2SL-69neB4t5eIIM",
            authDomain: "gametrak-69.firebaseapp.com",
            projectId: "gametrak-69",
            storageBucket: "gametrak-69.firebasestorage.app",
            messagingSenderId: "867080027370",
            appId: "1:867080027370:web:48e6203fd3b0e41ee36b93"
        };

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Encryption secret (in production, use environment variable)
        const SECRET_KEY = "gametrak-2025-secure-key-change-this";

        function encryptKey(key) {
            return CryptoJS.AES.encrypt(key, SECRET_KEY).toString();
        }

        function decryptKey(encryptedKey) {
            const bytes = CryptoJS.AES.decrypt(encryptedKey, SECRET_KEY);
            return bytes.toString(CryptoJS.enc.Utf8);
        }

        function GameTracker() {
            const [user, setUser] = useState(null);
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [confirmPassword, setConfirmPassword] = useState('');
            const [apiKey, setApiKey] = useState('');
            const [userApiKey, setUserApiKey] = useState('');
            const [isSignUp, setIsSignUp] = useState(false);
            const [searchQuery, setSearchQuery] = useState('');
            const [searchResults, setSearchResults] = useState([]);
            const [beatenGames, setBeatenGames] = useState([]);
            const [loading, setLoading] = useState(false);
            const [view, setView] = useState('search');

            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged(async (firebaseUser) => {
                    if (firebaseUser) {
                        setUser(firebaseUser.email);
                        await loadUserData(firebaseUser.uid);
                    } else {
                        setUser(null);
                        setUserApiKey('');
                        setBeatenGames([]);
                    }
                });
                return () => unsubscribe();
            }, []);

            const loadUserData = async (userId) => {
                try {
                    const userDoc = await db.collection('users').doc(userId).get();
                    if (userDoc.exists) {
                        const encryptedKey = userDoc.data().apiKey || '';
                        if (encryptedKey) {
                            setUserApiKey(decryptKey(encryptedKey));
                        }
                    }
                    const gamesSnapshot = await db.collection('users').doc(userId).collection('beatenGames').get();
                    const games = gamesSnapshot.docs.map(doc => ({ ...doc.data(), docId: doc.id }));
                    setBeatenGames(games);
                } catch (error) {
                    console.error('Error loading user data:', error);
                }
            };

            const handleSignUp = async () => {
                if (!username.trim() || !password.trim() || !apiKey.trim()) {
                    alert('Please enter email, password, and API key');
                    return;
                }
                if (password.length < 6) {
                    alert('Password must be at least 6 characters');
                    return;
                }
                if (password !== confirmPassword) {
                    alert('Passwords do not match');
                    return;
                }
                try {
                    const userCredential = await auth.createUserWithEmailAndPassword(username.trim(), password);
                    await db.collection('users').doc(userCredential.user.uid).set({
                        email: username.trim(),
                        apiKey: encryptKey(apiKey.trim()),
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    setUsername('');
                    setPassword('');
                    setConfirmPassword('');
                    setApiKey('');
                    setIsSignUp(false);
                    alert('Account created successfully!');
                } catch (error) {
                    if (error.code === 'auth/email-already-in-use') {
                        alert('Email already in use. Please use another email or login.');
                    } else if (error.code === 'auth/invalid-email') {
                        alert('Please enter a valid email address.');
                    } else {
                        alert('Failed to create account: ' + error.message);
                    }
                }
            };

            const handleLogin = async () => {
                if (!username.trim() || !password.trim()) {
                    alert('Please enter both email and password');
                    return;
                }
                try {
                    await auth.signInWithEmailAndPassword(username.trim(), password);
                    setUsername('');
                    setPassword('');
                    alert('Login successful!');
                } catch (error) {
                    if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                        alert('Invalid email or password');
                    } else {
                        alert('Login failed: ' + error.message);
                    }
                }
            };

            const handleLogout = async () => {
                try {
                    await auth.signOut();
                } catch (error) {
                    alert('Logout failed: ' + error.message);
                }
            };

            const searchGames = async () => {
                if (!searchQuery.trim()) return;
                if (!userApiKey) {
                    alert('Please sign in with a valid API key to search games');
                    return;
                }
                setLoading(true);
                try {
                    const response = await fetch(
                        `https://api.rawg.io/api/games?key=${userApiKey}&search=${encodeURIComponent(searchQuery)}&page_size=12`
                    );
                    const data = await response.json();
                    if (data.error) {
                        alert('Invalid API key. Please check your RAWG API key.');
                        setSearchResults([]);
                    } else {
                        setSearchResults(data.results || []);
                    }
                } catch (error) {
                    console.error('Search error:', error);
                    alert('Failed to search games. Please check your API key and try again.');
                }
                setLoading(false);
            };

            const addBeatenGame = async (game) => {
                if (!user || !auth.currentUser) {
                    alert('Please sign in to add games!');
                    return;
                }
                const gameData = {
                    id: game.id,
                    name: game.name,
                    image: game.background_image,
                    rating: game.rating,
                    released: game.released,
                    addedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                try {
                    await db.collection('users').doc(auth.currentUser.uid).collection('beatenGames').add(gameData);
                    setBeatenGames([...beatenGames, { ...gameData, docId: game.id }]);
                    alert(`Added "${game.name}" to your beaten games!`);
                } catch (error) {
                    alert('Failed to add game: ' + error.message);
                }
            };

            const removeBeatenGame = async (gameId) => {
                if (!auth.currentUser) return;
                try {
                    const snapshot = await db.collection('users').doc(auth.currentUser.uid).collection('beatenGames')
                        .where('id', '==', gameId).get();
                    snapshot.forEach(async (doc) => {
                        await doc.ref.delete();
                    });
                    setBeatenGames(beatenGames.filter(g => g.id !== gameId));
                } catch (error) {
                    alert('Failed to remove game: ' + error.message);
                }
            };

            const isGameBeaten = (gameId) => {
                return beatenGames.some(g => g.id === gameId);
            };

            const toggleAuthMode = () => {
                setIsSignUp(!isSignUp);
                setUsername('');
                setPassword('');
                setConfirmPassword('');
                setApiKey('');
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-purple-900 via-blue-900 to-indigo-900">
                    <div className="bg-black bg-opacity-40 backdrop-blur-sm border-b border-purple-500">
                        <div className="max-w-7xl mx-auto px-4 py-4">
                            <div className="flex items-center justify-between flex-wrap gap-4">
                                <div className="flex items-center gap-3">
                                    <i className="fas fa-gamepad text-purple-400 text-3xl"></i>
                                    <h1 className="text-2xl font-bold text-white">GameTrak</h1>
                                </div>
                                
                                <div className="flex items-center gap-4 flex-wrap">
                                    {user ? (
                                        <>
                                            <div className="flex items-center gap-2 text-white">
                                                <i className="fas fa-user"></i>
                                                <span className="font-medium">{user}</span>
                                            </div>
                                            <button
                                                onClick={handleLogout}
                                                className="flex items-center gap-2 px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition"
                                            >
                                                <i className="fas fa-sign-out-alt"></i>
                                                Logout
                                            </button>
                                        </>
                                    ) : (
                                        <div className="flex items-center gap-2 flex-wrap">
                                            <input
                                                type="email"
                                                value={username}
                                                onChange={(e) => setUsername(e.target.value)}
                                                onKeyDown={(e) => e.key === 'Enter' && (isSignUp ? handleSignUp() : handleLogin())}
                                                placeholder="Email"
                                                className="px-4 py-2 rounded-lg bg-white bg-opacity-20 text-white placeholder-gray-300 border border-purple-400 focus:outline-none focus:ring-2 focus:ring-purple-500"
                                            />
                                            <input
                                                type="password"
                                                value={password}
                                                onChange={(e) => setPassword(e.target.value)}
                                                onKeyDown={(e) => e.key === 'Enter' && (isSignUp ? handleSignUp() : handleLogin())}
                                                placeholder="Password"
                                                className="px-4 py-2 rounded-lg bg-white bg-opacity-20 text-white placeholder-gray-300 border border-purple-400 focus:outline-none focus:ring-2 focus:ring-purple-500"
                                            />
                                            {isSignUp && (
                                                <>
                                                    <input
                                                        type="password"
                                                        value={confirmPassword}
                                                        onChange={(e) => setConfirmPassword(e.target.value)}
                                                        onKeyDown={(e) => e.key === 'Enter' && handleSignUp()}
                                                        placeholder="Confirm Password"
                                                        className="px-4 py-2 rounded-lg bg-white bg-opacity-20 text-white placeholder-gray-300 border border-purple-400 focus:outline-none focus:ring-2 focus:ring-purple-500"
                                                    />
                                                    <div className="flex items-center gap-2">
                                                        <input
                                                            type="text"
                                                            value={apiKey}
                                                            onChange={(e) => setApiKey(e.target.value)}
                                                            onKeyDown={(e) => e.key === 'Enter' && handleSignUp()}
                                                            placeholder="RAWG API Key"
                                                            className="px-4 py-2 rounded-lg bg-white bg-opacity-20 text-white placeholder-gray-300 border border-purple-400 focus:outline-none focus:ring-2 focus:ring-purple-500"
                                                        />
                                                        <div className="relative group">
                                                            <i className="fas fa-info-circle text-purple-300 cursor-help"></i>
                                                            <div className="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 w-64 p-3 bg-gray-900 text-white text-sm rounded-lg shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 pointer-events-none z-50">
                                                                <p className="mb-2">Get your free RAWG API key:</p>
                                                                <a href="https://rawg.io/apidocs" target="_blank" rel="noopener noreferrer" className="text-purple-300 hover:text-purple-200 underline pointer-events-auto">
                                                                    rawg.io/apidocs
                                                                </a>
                                                                <div className="absolute top-full left-1/2 transform -translate-x-1/2 -mt-1">
                                                                    <div className="border-8 border-transparent border-t-gray-900"></div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </>
                                            )}
                                            <button
                                                onClick={isSignUp ? handleSignUp : handleLogin}
                                                className="flex items-center gap-2 px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition whitespace-nowrap"
                                            >
                                                <i className={isSignUp ? "fas fa-user-plus" : "fas fa-sign-in-alt"}></i>
                                                {isSignUp ? 'Sign Up' : 'Login'}
                                            </button>
                                            <button
                                                onClick={toggleAuthMode}
                                                className="text-purple-300 hover:text-purple-200 text-sm whitespace-nowrap"
                                            >
                                                {isSignUp ? 'Have an account?' : 'Need an account?'}
                                            </button>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="max-w-7xl mx-auto px-4 py-6">
                        <div className="flex gap-4 mb-6 flex-wrap">
                            <button
                                onClick={() => setView('search')}
                                className={`px-6 py-3 rounded-lg font-medium transition ${
                                    view === 'search'
                                        ? 'bg-purple-600 text-white'
                                        : 'bg-white bg-opacity-10 text-white hover:bg-opacity-20'
                                }`}
                            >
                                <i className="fas fa-search mr-2"></i>
                                Search Games
                            </button>
                            <button
                                onClick={() => setView('beaten')}
                                className={`px-6 py-3 rounded-lg font-medium transition ${
                                    view === 'beaten'
                                        ? 'bg-purple-600 text-white'
                                        : 'bg-white bg-opacity-10 text-white hover:bg-opacity-20'
                                }`}
                            >
                                <i className="fas fa-trophy mr-2"></i>
                                My Games ({beatenGames.length})
                            </button>
                        </div>

                        {view === 'search' && (
                            <div>
                                <div className="mb-8">
                                    <div className="flex gap-2 flex-wrap">
                                        <input
                                            type="text"
                                            value={searchQuery}
                                            onChange={(e) => setSearchQuery(e.target.value)}
                                            onKeyDown={(e) => e.key === 'Enter' && searchGames()}
                                            placeholder="Search for games (e.g., Halo, Zelda, Mario)..."
                                            className="flex-1 min-w-[250px] px-6 py-4 rounded-lg bg-white bg-opacity-10 text-white placeholder-gray-300 border border-purple-400 focus:outline-none focus:ring-2 focus:ring-purple-500 text-lg"
                                        />
                                        <button
                                            onClick={searchGames}
                                            disabled={loading}
                                            className="px-8 py-4 bg-purple-600 hover:bg-purple-700 disabled:bg-gray-600 text-white rounded-lg transition font-medium"
                                        >
                                            {loading ? 'Searching...' : 'Search'}
                                        </button>
                                    </div>
                                </div>

                                {searchResults.length > 0 && (
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                        {searchResults.map((game) => (
                                            <div
                                                key={game.id}
                                                className="bg-white bg-opacity-10 backdrop-blur-sm rounded-lg overflow-hidden border border-purple-500 hover:border-purple-400 transition"
                                            >
                                                {game.background_image && (
                                                    <img
                                                        src={game.background_image}
                                                        alt={game.name}
                                                        className="w-full h-48 object-cover"
                                                    />
                                                )}
                                                <div className="p-4">
                                                    <h3 className="text-xl font-bold text-white mb-2">
                                                        {game.name}
                                                    </h3>
                                                    <div className="flex items-center gap-2 text-gray-300 text-sm mb-3">
                                                        <i className="fas fa-star text-yellow-400"></i>
                                                        <span>{game.rating}/5</span>
                                                        {game.released && (
                                                            <span className="ml-auto">{game.released}</span>
                                                        )}
                                                    </div>
                                                    <button
                                                        onClick={() => addBeatenGame(game)}
                                                        disabled={isGameBeaten(game.id)}
                                                        className={`w-full flex items-center justify-center gap-2 px-4 py-2 rounded-lg transition font-medium ${
                                                            isGameBeaten(game.id)
                                                                ? 'bg-green-600 text-white cursor-not-allowed'
                                                                : 'bg-purple-600 hover:bg-purple-700 text-white'
                                                        }`}
                                                    >
                                                        <i className={isGameBeaten(game.id) ? "fas fa-trophy" : "fas fa-plus"}></i>
                                                        {isGameBeaten(game.id) ? 'Already Beaten' : 'Mark as Beaten'}
                                                    </button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        )}

                        {view === 'beaten' && (
                            <div>
                                {!user ? (
                                    <div className="text-center py-16">
                                        <i className="fas fa-user text-purple-400 text-6xl mb-4"></i>
                                        <p className="text-xl text-white mb-2">Sign in to track your games!</p>
                                        <p className="text-gray-300">Create an account to save your beaten games.</p>
                                    </div>
                                ) : beatenGames.length === 0 ? (
                                    <div className="text-center py-16">
                                        <i className="fas fa-trophy text-purple-400 text-6xl mb-4"></i>
                                        <p className="text-xl text-white mb-2">No games beaten yet!</p>
                                        <p className="text-gray-300">Search for games and mark them as beaten.</p>
                                    </div>
                                ) : (
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                        {beatenGames.map((game) => (
                                            <div
                                                key={game.id}
                                                className="bg-white bg-opacity-10 backdrop-blur-sm rounded-lg overflow-hidden border border-green-500 hover:border-green-400 transition"
                                            >
                                                {game.image && (
                                                    <img
                                                        src={game.image}
                                                        alt={game.name}
                                                        className="w-full h-48 object-cover"
                                                    />
                                                )}
                                                <div className="p-4">
                                                    <div className="flex items-start justify-between mb-2">
                                                        <h3 className="text-xl font-bold text-white flex-1">
                                                            {game.name}
                                                        </h3>
                                                        <i className="fas fa-trophy text-yellow-400 text-2xl ml-2"></i>
                                                    </div>
                                                    <div className="flex items-center gap-2 text-gray-300 text-sm mb-3">
                                                        <i className="fas fa-star text-yellow-400"></i>
                                                        <span>{game.rating}/5</span>
                                                        {game.released && (
                                                            <span className="ml-auto">{game.released}</span>
                                                        )}
                                                    </div>
                                                    <button
                                                        onClick={() => removeBeatenGame(game.id)}
                                                        className="w-full flex items-center justify-center gap-2 px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition font-medium"
                                                    >
                                                        <i className="fas fa-trash"></i>
                                                        Remove
                                                    </button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        ReactDOM.render(<GameTracker />, document.getElementById('root'));
    </script>
</body>
</html>
